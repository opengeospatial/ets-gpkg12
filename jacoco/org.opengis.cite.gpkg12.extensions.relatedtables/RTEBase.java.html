<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RTEBase.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">GeoPackage 1.2 Conformance Test Suite</a> &gt; <a href="index.source.html" class="el_package">org.opengis.cite.gpkg12.extensions.relatedtables</a> &gt; <span class="el_source">RTEBase.java</span></div><h1>RTEBase.java</h1><pre class="source lang-java linenums">package org.opengis.cite.gpkg12.extensions.relatedtables;

import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;

import org.opengis.cite.gpkg12.CommonFixture;
import org.opengis.cite.gpkg12.ErrorMessage;
import org.opengis.cite.gpkg12.ErrorMessageKeys;
import org.opengis.cite.gpkg12.util.DatabaseUtility;
import org.testng.Assert;
import org.testng.ITestContext;
import org.testng.annotations.BeforeClass;

<span class="fc" id="L15">public abstract class RTEBase extends CommonFixture {</span>

	/**
	 * Helper function to determine if the extension is active. This is used for the main
	 * extension and each of its requirements classes.
	 * @param testContext a context object
	 * @throws SQLException On any SQL query error or test failure
	 *
	 */
	@BeforeClass
	protected void activeExtension(ITestContext testContext) throws SQLException {
<span class="fc" id="L26">		Assert.assertTrue(DatabaseUtility.doesTableOrViewExist(this.databaseConnection, &quot;gpkg_extensions&quot;),</span>
<span class="fc" id="L27">				ErrorMessage.format(ErrorMessageKeys.CONFORMANCE_CLASS_NOT_USED, &quot;Related Tables Extension&quot;));</span>

<span class="fc" id="L29">		try (final Statement statement = this.databaseConnection.createStatement();</span>

<span class="fc" id="L31">				final ResultSet resultSet = statement.executeQuery(</span>
						&quot;SELECT count(*) from gpkg_extensions WHERE extension_name IN ('related_tables', 'gpkg_related_tables');&quot;);) {
<span class="fc" id="L33">			resultSet.next();</span>

<span class="fc bfc" id="L35" title="All 2 branches covered.">			Assert.assertTrue(resultSet.getInt(1) &gt; 0,</span>
<span class="fc" id="L36">					ErrorMessage.format(ErrorMessageKeys.CONFORMANCE_CLASS_NOT_USED, &quot;Related Tables Extension&quot;));</span>
		}
<span class="fc" id="L38">	}</span>

	/**
	 * a helper function for RTE requirements classes
	 * @param relationName a relation name like &quot;media&quot;
	 * @param className a human-readable name for a requirements class like &quot;Media&quot;
	 * @throws SQLException On any SQL query error or test failure
	 *
	 */
	protected void testRequirementsClassActive(String relationName, String className) throws SQLException {
<span class="fc" id="L48">		try (final Statement statement = this.databaseConnection.createStatement();</span>

<span class="fc" id="L50">				final ResultSet resultSet = statement.executeQuery(String</span>
<span class="fc" id="L51">					.format(&quot;SELECT COUNT(*) FROM gpkgext_relations WHERE relation_name = '%s'&quot;, relationName));) {</span>
<span class="fc" id="L52">			resultSet.next();</span>

<span class="fc bfc" id="L54" title="All 2 branches covered.">			Assert.assertTrue(resultSet.getInt(1) &gt; 0, ErrorMessage.format(ErrorMessageKeys.CONFORMANCE_CLASS_NOT_USED,</span>
<span class="fc" id="L55">					String.format(&quot;Related Tables Extension, %s Requirements Class&quot;, className)));</span>
		}
<span class="fc" id="L57">	}</span>

	/**
	 * A helper function for RTE requirements classes to determine whether the related
	 * data is of the expected type
	 * @param relationName a relation name (e.g., &quot;media&quot;)
	 * @param requiredType the expected data type in gpkg_contents (e.g., &quot;attributes&quot;)
	 * @throws SQLException On any SQL query error or test failure
	 *
	 */
	protected void testRelatedType(String relationName, String requiredType) throws SQLException {
<span class="fc" id="L68">		try (final Statement statement = this.databaseConnection.createStatement();</span>

<span class="fc" id="L70">				final ResultSet resultSet = statement.executeQuery(</span>
<span class="fc" id="L71">						String.format(&quot;SELECT related_table_name FROM gpkgext_relations WHERE relation_name = '%s';&quot;,</span>
								relationName));) {
<span class="fc bfc" id="L73" title="All 2 branches covered.">			while (resultSet.next()) {</span>

<span class="fc" id="L75">				final String relatedTableName = resultSet.getString(&quot;related_table_name&quot;);</span>

<span class="fc" id="L77">				try (final Statement statement2 = this.databaseConnection.createStatement();</span>

<span class="fc" id="L79">						final ResultSet resultSet2 = statement2.executeQuery(String.format(</span>
								&quot;SELECT data_type FROM gpkg_contents WHERE table_name = '%s';&quot;, relatedTableName));) {

<span class="fc" id="L82">					Assert.assertTrue(resultSet2.next(), ErrorMessage.format(ErrorMessageKeys.MISSING_REFERENCE,</span>
							&quot;gpkg_contents&quot;, &quot;table_name&quot;, relatedTableName));
<span class="fc" id="L84">					final String dataType = resultSet2.getString(&quot;data_type&quot;);</span>
<span class="fc" id="L85">					Assert.assertEquals(dataType, requiredType, ErrorMessage.format(ErrorMessageKeys.INVALID_DATA_TYPE,</span>
							dataType, relatedTableName, &quot;gpkgext_relations&quot;));
				}
<span class="fc" id="L88">			}</span>
		}
<span class="fc" id="L90">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>