<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>URIUtils.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">GeoPackage 1.2 Conformance Test Suite</a> &gt; <a href="index.source.html" class="el_package">org.opengis.cite.gpkg12.util</a> &gt; <span class="el_source">URIUtils.java</span></div><h1>URIUtils.java</h1><pre class="source lang-java linenums">package org.opengis.cite.gpkg12.util;

import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.net.URI;
import java.net.URISyntaxException;
import java.util.logging.Level;

import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;
import javax.xml.parsers.ParserConfigurationException;

import org.w3c.dom.Document;
import org.xml.sax.SAXException;

import jakarta.ws.rs.client.Client;
import jakarta.ws.rs.client.ClientBuilder;
import jakarta.ws.rs.client.Invocation.Builder;
import jakarta.ws.rs.client.WebTarget;
import jakarta.ws.rs.core.Response;

/**
 * Provides a collection of utility methods for manipulating or resolving URI references.
 */
<span class="nc" id="L28">public class URIUtils {</span>

	private static final String FIXUP_BASE_URI = &quot;http://apache.org/xml/features/xinclude/fixup-base-uris&quot;;

	/**
	 * Parses the content of the given URI as an XML document and returns a new DOM
	 * Document object. Entity reference nodes will not be expanded. XML inclusions
	 * (xi:include elements) will be processed if present.
	 * @param uriRef An absolute URI specifying the location of an XML resource.
	 * @return A DOM Document node representing an XML resource.
	 * @throws SAXException If the resource cannot be parsed.
	 * @throws IOException If the resource is not accessible.
	 */
	public static Document parseURI(URI uriRef) throws SAXException, IOException {
<span class="pc bpc" id="L42" title="1 of 4 branches missed.">		if ((null == uriRef) || !uriRef.isAbsolute()) {</span>
<span class="fc" id="L43">			throw new IllegalArgumentException(&quot;Absolute URI is required, but received &quot; + uriRef);</span>
		}
<span class="fc" id="L45">		DocumentBuilderFactory docFactory = DocumentBuilderFactory.newInstance();</span>
<span class="fc" id="L46">		docFactory.setNamespaceAware(true);</span>
<span class="fc" id="L47">		docFactory.setExpandEntityReferences(false);</span>
<span class="fc" id="L48">		docFactory.setXIncludeAware(true);</span>
<span class="fc" id="L49">		Document doc = null;</span>
		try {
			// XInclude processor will not add xml:base attributes
<span class="fc" id="L52">			docFactory.setFeature(FIXUP_BASE_URI, false);</span>
<span class="fc" id="L53">			DocumentBuilder docBuilder = docFactory.newDocumentBuilder();</span>
<span class="fc" id="L54">			doc = docBuilder.parse(uriRef.toString());</span>
		}
<span class="nc" id="L56">		catch (ParserConfigurationException x) {</span>
<span class="nc" id="L57">			TestSuiteLogger.log(Level.WARNING, &quot;Failed to create DocumentBuilder.&quot; + x);</span>
<span class="fc" id="L58">		}</span>
<span class="pc bpc" id="L59" title="1 of 2 branches missed.">		if (null != doc) {</span>
<span class="fc" id="L60">			doc.setDocumentURI(uriRef.toString());</span>
		}
<span class="fc" id="L62">		return doc;</span>
	}

	/**
	 * Dereferences the given URI and stores the resulting resource representation in a
	 * local file. The file will be located in the default temporary file directory.
	 * @param uriRef An absolute URI specifying the location of some resource. If a
	 * relative URI is provided, it will be turned into a file URI
	 * @return A File containing the content of the resource; it may be empty if
	 * resolution failed for any reason.
	 * @throws IOException If an IO error occurred.
	 */
	public static File dereferenceURI(URI uriRef) throws IOException {
<span class="pc bpc" id="L75" title="1 of 2 branches missed.">		if (null == uriRef) {</span>
<span class="nc" id="L76">			throw new IllegalArgumentException(&quot;Absolute URI is required, but received none&quot;);</span>
		}
<span class="pc bpc" id="L78" title="1 of 2 branches missed.">		if (!uriRef.isAbsolute()) {</span>
			try {
<span class="nc" id="L80">				return dereferenceURI(new URI(String.format(&quot;file://%s&quot;, uriRef.toASCIIString())));</span>
			}
<span class="nc" id="L82">			catch (URISyntaxException e) {</span>
<span class="nc" id="L83">				throw new IllegalArgumentException(&quot;Absolute URI is required, but received &quot; + uriRef);</span>
			}
		}
<span class="pc bpc" id="L86" title="1 of 2 branches missed.">		if (uriRef.getScheme().equalsIgnoreCase(&quot;file&quot;)) {</span>
<span class="fc" id="L87">			return new File(uriRef);</span>
		}
<span class="nc" id="L89">		Client client = ClientBuilder.newClient();</span>
<span class="nc" id="L90">		WebTarget target = client.target(uriRef);</span>
<span class="nc" id="L91">		Builder builder = target.request();</span>
<span class="nc" id="L92">		Response rsp = builder.buildGet().invoke();</span>
<span class="nc" id="L93">		int lastIndexOfDot = uriRef.getPath().lastIndexOf('.');</span>
		// preserve suffix if possible
<span class="nc bnc" id="L95" title="All 2 branches missed.">		String suffix = (lastIndexOfDot &gt; 0) ? uriRef.getPath().substring(lastIndexOfDot) : &quot;.db&quot;;</span>
<span class="nc" id="L96">		File destFile = File.createTempFile(&quot;gpkg-&quot;, suffix);</span>
<span class="nc bnc" id="L97" title="All 2 branches missed.">		if (rsp.hasEntity()) {</span>
<span class="nc" id="L98">			Object entity = rsp.getEntity();</span>
<span class="nc bnc" id="L99" title="All 2 branches missed.">			if (!(entity instanceof InputStream)) {</span>
<span class="nc" id="L100">				return null;</span>
			}
<span class="nc" id="L102">			InputStream is = (InputStream) entity;</span>
<span class="nc" id="L103">			OutputStream os = new FileOutputStream(destFile);</span>
<span class="nc" id="L104">			byte[] buffer = new byte[8 * 1024];</span>
			int bytesRead;
<span class="nc bnc" id="L106" title="All 2 branches missed.">			while ((bytesRead = is.read(buffer)) != -1) {</span>
<span class="nc" id="L107">				os.write(buffer, 0, bytesRead);</span>
			}
<span class="nc" id="L109">			is.close();</span>
<span class="nc" id="L110">			os.flush();</span>
<span class="nc" id="L111">			os.close();</span>
		}
<span class="nc" id="L113">		TestSuiteLogger.log(Level.CONFIG,</span>
<span class="nc" id="L114">				&quot;Wrote &quot; + destFile.length() + &quot; bytes to file at &quot; + destFile.getAbsolutePath());</span>
<span class="nc" id="L115">		return destFile;</span>
	}

	/**
	 * Constructs an absolute URI from the given URI reference and a base URI.
	 *
	 * @see &lt;a href=&quot;http://tools.ietf.org/html/rfc3986#section-5.2&quot;&gt;RFC 3986, 5.2&lt;/a&gt;
	 * @param baseURI The base URI; if present, it must be an absolute URI.
	 * @param uriRef A URI reference that may be relative to the given base URI.
	 * @return The resulting URI.
	 *
	 */
	public static URI resolveRelativeURI(String baseURI, String uriRef) {
<span class="pc bpc" id="L128" title="1 of 2 branches missed.">		URI uri = (null != baseURI) ? URI.create(baseURI) : URI.create(&quot;&quot;);</span>
<span class="pc bpc" id="L129" title="2 of 4 branches missed.">		if (null != baseURI &amp;&amp; null == uri.getScheme()) {</span>
<span class="nc" id="L130">			throw new IllegalArgumentException(&quot;Base URI has no scheme component: &quot; + baseURI);</span>
		}
<span class="fc" id="L132">		return uri.resolve(uriRef);</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>